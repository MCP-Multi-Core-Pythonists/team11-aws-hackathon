<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Hub</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .auth-section { margin: 20px 0; padding: 20px; border: 1px solid #e1e5e9; border-radius: 6px; }
        .admin-panel { background: #f8f9fa; border-color: #28a745; }
        button { background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #3367d6; }
        .logout-btn { background: #dc3545; }
        .logout-btn:hover { background: #c82333; }
        .hidden { display: none; }
        .user-info { background: #e7f3ff; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .loading { color: #666; font-style: italic; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Sync Hub Web Console</h1>
        
        <div id="login-section" class="auth-section">
            <h2>Welcome to Sync Hub</h2>
            <p>Sign in with your Google account to access your settings sync.</p>
            <button onclick="loginWithGoogle()">üîê Sign in with Google</button>
        </div>
        
        <div id="loading-section" class="auth-section hidden">
            <h2>Signing you in...</h2>
            <p class="loading">Processing authentication...</p>
        </div>
        
        <div id="user-section" class="auth-section hidden">
            <h2>‚úÖ Welcome back!</h2>
            <div class="user-info">
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <p><strong>Name:</strong> <span id="user-name"></span></p>
                <p><strong>Tenant:</strong> <span id="user-tenant"></span></p>
            </div>
            <button class="logout-btn" onclick="logout()">Sign Out</button>
        </div>
        
        <div id="admin-panel" class="auth-section admin-panel hidden">
            <h2>üõ†Ô∏è Admin Panel</h2>
            <p>You have administrative privileges for this tenant.</p>
            <div>
                <h3>Quick Actions</h3>
                <button onclick="alert('Admin feature coming soon!')">Manage Users</button>
                <button onclick="alert('Admin feature coming soon!')">View Analytics</button>
            </div>
        </div>
        
        <div id="error-section" class="error hidden">
            <strong>Authentication Error:</strong> <span id="error-message"></span>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            CLIENT_ID: '7n568rmtbtp2tt8m0av2hl0f2n',
            DOMAIN: 'sync-hub-851725240440',
            REGION: 'us-east-1',
            REDIRECT_URI: window.location.origin + '/callback'
        };
        
        // PKCE utilities
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }
        
        function base64URLEncode(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }
        
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(digest);
        }
        
        // Authentication functions
        async function loginWithGoogle() {
            try {
                // Generate PKCE parameters
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Store verifier for callback
                sessionStorage.setItem('pkce_verifier', codeVerifier);
                
                // Build authorization URL
                const params = new URLSearchParams({
                    client_id: CONFIG.CLIENT_ID,
                    response_type: 'code',
                    scope: 'openid email profile',
                    redirect_uri: CONFIG.REDIRECT_URI,
                    identity_provider: 'Google',
                    code_challenge: codeChallenge,
                    code_challenge_method: 'S256'
                });
                
                const authUrl = `https://${CONFIG.DOMAIN}.auth.${CONFIG.REGION}.amazoncognito.com/oauth2/authorize?${params}`;
                window.location.href = authUrl;
            } catch (error) {
                showError('Failed to initiate login: ' + error.message);
            }
        }
        
        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                showError('OAuth error: ' + (urlParams.get('error_description') || error));
                return;
            }
            
            if (!code) {
                showError('No authorization code received');
                return;
            }
            
            showLoading();
            
            try {
                // Get PKCE verifier
                const codeVerifier = sessionStorage.getItem('pkce_verifier');
                if (!codeVerifier) {
                    throw new Error('PKCE verifier not found');
                }
                
                // Exchange code for tokens
                const tokenResponse = await fetch(`https://${CONFIG.DOMAIN}.auth.${CONFIG.REGION}.amazoncognito.com/oauth2/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CONFIG.CLIENT_ID,
                        code: code,
                        redirect_uri: CONFIG.REDIRECT_URI,
                        code_verifier: codeVerifier
                    })
                });
                
                if (!tokenResponse.ok) {
                    const errorData = await tokenResponse.text();
                    throw new Error(`Token exchange failed: ${tokenResponse.status} - ${errorData}`);
                }
                
                const tokens = await tokenResponse.json();
                
                // Store tokens
                localStorage.setItem('access_token', tokens.access_token);
                localStorage.setItem('id_token', tokens.id_token);
                if (tokens.refresh_token) {
                    localStorage.setItem('refresh_token', tokens.refresh_token);
                }
                
                // Clean up
                sessionStorage.removeItem('pkce_verifier');
                
                // Redirect to main app
                window.location.replace('/');
                
            } catch (error) {
                console.error('Token exchange error:', error);
                showError('Authentication failed: ' + error.message);
                sessionStorage.removeItem('pkce_verifier');
            }
        }
        
        function logout() {
            // Clear tokens
            localStorage.removeItem('access_token');
            localStorage.removeItem('id_token');
            localStorage.removeItem('refresh_token');
            sessionStorage.removeItem('pkce_verifier');
            
            // Redirect to Cognito logout
            const logoutUrl = `https://${CONFIG.DOMAIN}.auth.${CONFIG.REGION}.amazoncognito.com/logout?client_id=${CONFIG.CLIENT_ID}&logout_uri=${encodeURIComponent(window.location.origin)}`;
            window.location.href = logoutUrl;
        }
        
        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('JWT parse error:', error);
                return null;
            }
        }
        
        function showLoading() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('loading-section').classList.remove('hidden');
        }
        
        function showLoginSection() {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
        }
        
        function showUserSection(userInfo) {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('user-section').classList.remove('hidden');
            
            document.getElementById('user-email').textContent = userInfo.email || 'N/A';
            document.getElementById('user-name').textContent = (userInfo.given_name || '') + ' ' + (userInfo.family_name || '');
            document.getElementById('user-tenant').textContent = userInfo.tenant_id || 'default';
            
            if (userInfo.is_admin) {
                document.getElementById('admin-panel').classList.remove('hidden');
            } else {
                document.getElementById('admin-panel').classList.add('hidden');
            }
        }
        
        function showError(message) {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('error-section').classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
        
        // Initialize app
        function initApp() {
            // Handle callback
            if (window.location.pathname === '/callback') {
                handleCallback();
                return;
            }
            
            // Check if user is logged in
            const idToken = localStorage.getItem('id_token');
            if (idToken) {
                const payload = parseJWT(idToken);
                if (payload && payload.exp > Date.now() / 1000) {
                    showUserSection(payload);
                    return;
                }
                // Token expired, clear it
                localStorage.removeItem('id_token');
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
            }
            
            showLoginSection();
        }
        
        // Start the app
        initApp();
    </script>
</body>
</html>