# 005-데이터베이스설계.md

## 데이터베이스 아키텍처

### 기술 스택
- **Primary Database**: PostgreSQL 14+
- **Cache Layer**: Redis 7+
- **ORM**: Sequelize 6+
- **Migration**: Sequelize CLI

### 데이터베이스 스키마

#### 1. Users (사용자)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    avatar TEXT,
    provider VARCHAR(50) NOT NULL CHECK (provider IN ('google', 'github', 'email')),
    provider_id VARCHAR(255),
    email_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT unique_provider_id UNIQUE (provider, provider_id)
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_provider ON users(provider, provider_id);
```

#### 2. Teams (팀)
```sql
CREATE TABLE teams (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT team_name_length CHECK (length(name) >= 2 AND length(name) <= 100)
);

CREATE INDEX idx_teams_owner ON teams(owner_id);
CREATE INDEX idx_teams_name ON teams(name);
```

#### 3. Team Members (팀 멤버)
```sql
CREATE TABLE team_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(50) NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    invited_by UUID REFERENCES users(id),
    
    CONSTRAINT unique_team_member UNIQUE (team_id, user_id)
);

CREATE INDEX idx_team_members_team ON team_members(team_id);
CREATE INDEX idx_team_members_user ON team_members(user_id);
CREATE INDEX idx_team_members_role ON team_members(team_id, role);
```

#### 4. Configurations (설정)
```sql
CREATE TABLE configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    editor_type VARCHAR(50) NOT NULL DEFAULT 'vscode' CHECK (editor_type IN ('vscode', 'cursor')),
    settings JSONB NOT NULL DEFAULT '{}',
    version INTEGER NOT NULL DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT config_name_length CHECK (length(name) >= 1 AND length(name) <= 100)
);

CREATE INDEX idx_configurations_team ON configurations(team_id);
CREATE INDEX idx_configurations_version ON configurations(team_id, version DESC);
CREATE INDEX idx_configurations_active ON configurations(team_id, is_active);
CREATE INDEX idx_configurations_creator ON configurations(created_by);
```

#### 5. Configuration History (설정 히스토리)
```sql
CREATE TABLE configuration_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    configuration_id UUID NOT NULL REFERENCES configurations(id) ON DELETE CASCADE,
    version INTEGER NOT NULL,
    settings JSONB NOT NULL,
    change_summary TEXT,
    changed_by UUID NOT NULL REFERENCES users(id),
    changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT unique_config_version UNIQUE (configuration_id, version)
);

CREATE INDEX idx_config_history_config ON configuration_history(configuration_id);
CREATE INDEX idx_config_history_version ON configuration_history(configuration_id, version DESC);
```

#### 6. Prompts (프롬프트)
```sql
CREATE TABLE prompts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    content TEXT NOT NULL,
    category VARCHAR(100) DEFAULT 'general',
    tags TEXT[] DEFAULT '{}',
    is_public BOOLEAN DEFAULT FALSE,
    usage_count INTEGER DEFAULT 0,
    created_by UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT prompt_name_length CHECK (length(name) >= 1 AND length(name) <= 100),
    CONSTRAINT prompt_content_length CHECK (length(content) >= 1)
);

CREATE INDEX idx_prompts_team ON prompts(team_id);
CREATE INDEX idx_prompts_category ON prompts(category);
CREATE INDEX idx_prompts_public ON prompts(is_public);
CREATE INDEX idx_prompts_tags ON prompts USING GIN(tags);
CREATE INDEX idx_prompts_creator ON prompts(created_by);
```

#### 7. Invitations (초대)
```sql
CREATE TABLE invitations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    email VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL DEFAULT 'member' CHECK (role IN ('admin', 'member')),
    token VARCHAR(255) UNIQUE NOT NULL,
    invited_by UUID NOT NULL REFERENCES users(id),
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    accepted_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT unique_pending_invitation UNIQUE (team_id, email)
);

CREATE INDEX idx_invitations_token ON invitations(token);
CREATE INDEX idx_invitations_email ON invitations(email);
CREATE INDEX idx_invitations_expires ON invitations(expires_at);
```

#### 8. Audit Logs (감사 로그)
```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    team_id UUID REFERENCES teams(id),
    action VARCHAR(100) NOT NULL,
    resource VARCHAR(100) NOT NULL,
    resource_id UUID,
    metadata JSONB DEFAULT '{}',
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_team ON audit_logs(team_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource, resource_id);
CREATE INDEX idx_audit_logs_created ON audit_logs(created_at DESC);
```

#### 9. Refresh Tokens (리프레시 토큰)
```sql
CREATE TABLE refresh_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_used_at TIMESTAMP WITH TIME ZONE,
    revoked_at TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT valid_expiry CHECK (expires_at > created_at)
);

CREATE INDEX idx_refresh_tokens_user ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_hash ON refresh_tokens(token_hash);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens(expires_at);
```

### 데이터 관계도

```
Users (1) ←→ (N) Team_Members (N) ←→ (1) Teams
  ↓                                        ↓
  (1)                                      (1)
  ↓                                        ↓
Refresh_Tokens (N)                 Configurations (N)
  ↓                                        ↓
Audit_Logs (N)                    Config_History (N)
                                           ↓
                                   Prompts (N)
                                           ↓
                                   Invitations (N)
```

### 인덱스 전략

#### 성능 최적화 인덱스
```sql
-- 복합 인덱스 (자주 함께 조회되는 컬럼)
CREATE INDEX idx_team_members_team_role ON team_members(team_id, role);
CREATE INDEX idx_configurations_team_active ON configurations(team_id, is_active, version DESC);
CREATE INDEX idx_prompts_team_public ON prompts(team_id, is_public);

-- 부분 인덱스 (조건부 인덱스)
CREATE INDEX idx_invitations_pending ON invitations(team_id, email) 
WHERE accepted_at IS NULL AND expires_at > NOW();

CREATE INDEX idx_refresh_tokens_active ON refresh_tokens(user_id, expires_at) 
WHERE revoked_at IS NULL;

-- 전문 검색 인덱스
CREATE INDEX idx_prompts_search ON prompts USING GIN(to_tsvector('english', name || ' ' || description || ' ' || content));
```

### 데이터 마이그레이션

#### 초기 마이그레이션 스크립트
```javascript
// migrations/001-create-users.js
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('users', {
      id: {
        type: Sequelize.UUID,
        defaultValue: Sequelize.UUIDV4,
        primaryKey: true
      },
      email: {
        type: Sequelize.STRING(255),
        allowNull: false,
        unique: true
      },
      name: {
        type: Sequelize.STRING(255),
        allowNull: false
      },
      // ... 기타 필드
      createdAt: {
        type: Sequelize.DATE,
        defaultValue: Sequelize.NOW
      },
      updatedAt: {
        type: Sequelize.DATE,
        defaultValue: Sequelize.NOW
      }
    });

    // 인덱스 생성
    await queryInterface.addIndex('users', ['email']);
    await queryInterface.addIndex('users', ['provider', 'provider_id']);
  },

  down: async (queryInterface) => {
    await queryInterface.dropTable('users');
  }
};
```

### 시드 데이터

#### 개발용 시드 데이터
```javascript
// seeders/001-demo-users.js
module.exports = {
  up: async (queryInterface) => {
    await queryInterface.bulkInsert('users', [
      {
        id: '550e8400-e29b-41d4-a716-446655440000',
        email: 'demo@teamsync.dev',
        name: 'Demo User',
        provider: 'email',
        emailVerified: true,
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ]);

    await queryInterface.bulkInsert('teams', [
      {
        id: '550e8400-e29b-41d4-a716-446655440001',
        name: 'Demo Team',
        description: 'TeamSync Pro 데모 팀',
        ownerId: '550e8400-e29b-41d4-a716-446655440000',
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ]);
  },

  down: async (queryInterface) => {
    await queryInterface.bulkDelete('teams', null, {});
    await queryInterface.bulkDelete('users', null, {});
  }
};
```

### 백업 및 복구 전략

#### 자동 백업 설정
```bash
#!/bin/bash
# scripts/backup.sh

DB_NAME="teamsync_prod"
BACKUP_DIR="/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)

# 전체 백업
pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME -f "$BACKUP_DIR/full_backup_$DATE.sql"

# 압축
gzip "$BACKUP_DIR/full_backup_$DATE.sql"

# 7일 이상 된 백업 파일 삭제
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

#### 복구 스크립트
```bash
#!/bin/bash
# scripts/restore.sh

BACKUP_FILE=$1
DB_NAME="teamsync_prod"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file>"
    exit 1
fi

# 데이터베이스 재생성
dropdb -h $DB_HOST -U $DB_USER $DB_NAME
createdb -h $DB_HOST -U $DB_USER $DB_NAME

# 백업 복구
gunzip -c $BACKUP_FILE | psql -h $DB_HOST -U $DB_USER -d $DB_NAME
```

### 성능 모니터링

#### 쿼리 성능 분석
```sql
-- 느린 쿼리 식별
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- 인덱스 사용률 확인
SELECT schemaname, tablename, attname, n_distinct, correlation
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY n_distinct DESC;

-- 테이블 크기 모니터링
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### Redis 캐시 전략

#### 캐시 키 네이밍 규칙
```
user:{user_id}                    # 사용자 정보
team:{team_id}                    # 팀 정보
team:{team_id}:members           # 팀 멤버 목록
config:{team_id}:latest          # 최신 설정
prompts:{team_id}                # 팀 프롬프트 목록
session:{session_id}             # 세션 정보
```

#### 캐시 TTL 설정
```javascript
const CACHE_TTL = {
  USER_INFO: 3600,        // 1시간
  TEAM_INFO: 1800,        // 30분
  TEAM_MEMBERS: 900,      // 15분
  CONFIGURATIONS: 600,    // 10분
  PROMPTS: 1800,         // 30분
  SESSION: 86400         // 24시간
};
```

### 데이터베이스 보안

#### 접근 제어
```sql
-- 읽기 전용 사용자 생성
CREATE USER teamsync_readonly WITH PASSWORD 'secure_password';
GRANT CONNECT ON DATABASE teamsync TO teamsync_readonly;
GRANT USAGE ON SCHEMA public TO teamsync_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO teamsync_readonly;

-- 애플리케이션 사용자
CREATE USER teamsync_app WITH PASSWORD 'app_password';
GRANT CONNECT ON DATABASE teamsync TO teamsync_app;
GRANT USAGE, CREATE ON SCHEMA public TO teamsync_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO teamsync_app;
```

#### 데이터 암호화
```sql
-- 민감한 데이터 암호화 (예: 토큰)
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 암호화된 컬럼 예시
ALTER TABLE refresh_tokens 
ADD COLUMN encrypted_data TEXT;

-- 암호화 함수 사용
INSERT INTO refresh_tokens (encrypted_data) 
VALUES (pgp_sym_encrypt('sensitive_data', 'encryption_key'));
```
